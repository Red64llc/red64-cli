#!/bin/bash
set -e

# Kiro Flow - Spec-Driven Development Orchestrator
# Manages the complete Kiro workflow with git integration

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default: permissions are enabled (skip-permissions is OFF)
SKIP_PERMISSIONS=""
# Default: greenfield mode (no existing codebase)
PROJECT_MODE="greenfield"
# Default: standard claude config directory
CLAUDE_CONFIG_DIR="$HOME/.claude"

# Parse global options before command
while [[ "${1:-}" =~ ^- ]]; do
    case "$1" in
        --skip-permissions|-s)
            SKIP_PERMISSIONS="--dangerously-skip-permissions"
            shift
            ;;
        --brownfield|-b)
            PROJECT_MODE="brownfield"
            shift
            ;;
        --greenfield|-g)
            PROJECT_MODE="greenfield"
            shift
            ;;
        --tier|-t)
            if [ -z "$2" ] || [[ "$2" =~ ^- ]]; then
                echo -e "${RED}Error: --tier requires a value${NC}"
                echo "Usage: kiro-flow --tier <tier-name> ..."
                echo "Example: kiro-flow --tier rocketable start user-auth \"description\""
                exit 1
            fi
            CLAUDE_CONFIG_DIR="$HOME/.claude-$2"
            shift 2
            ;;
        --tier=*)
            TIER_VALUE="${1#--tier=}"
            if [ -z "$TIER_VALUE" ]; then
                echo -e "${RED}Error: --tier requires a value${NC}"
                exit 1
            fi
            CLAUDE_CONFIG_DIR="$HOME/.claude-$TIER_VALUE"
            shift
            ;;
        --help|-h)
            break  # Let the help command handle it
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            exit 1
            ;;
    esac
done

# Export for claude command
export CLAUDE_CONFIG_DIR

print_header() {
    echo -e "${BLUE}╔════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║      Kiro Flow Orchestrator            ║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════╝${NC}"
    echo ""
}

print_help() {
    print_header
    cat << 'EOF'
Spec-Driven Development with Git Integration

USAGE:
    kiro-flow [options] <command> [arguments]

OPTIONS:
    -s, --skip-permissions
        Run claude with --dangerously-skip-permissions flag.
        By default, Claude will prompt for permission on sensitive operations.

    -g, --greenfield (default)
        Greenfield mode for new projects with no existing codebase.
        Workflow: init → requirements → design → tasks → impl → validation → PR

    -b, --brownfield
        Brownfield mode for existing projects with existing codebase.
        Adds gap analysis and design validation steps:
        Workflow: init → requirements → GAP ANALYSIS → design → DESIGN VALIDATION → tasks → impl → validation → PR

    -t, --tier <tier-name>
        Use a specific Claude configuration tier/profile.
        Sets CLAUDE_CONFIG_DIR to ~/.claude-<tier-name>
        Default: ~/.claude (no tier specified)
        Example: --tier rocketable → uses ~/.claude-rocketable

COMMANDS:
    start <feature> "<description>"
        Start a new feature development flow.
        Creates a git worktree, runs the complete Kiro spec workflow
        with granular commits and HITL approval gates.

    resume <feature>
        Resume a paused or interrupted flow.
        Reads state from flow-state.json and continues from last checkpoint.

    status [feature]
        Show status of active flows.
        If feature specified, shows detailed status.
        Without arguments, shows summary of all active flows.

    list
        List all active feature flows with their current phase.

    abort <feature>
        Abort a flow and cleanup resources.
        Removes worktree, optionally deletes branch.

EXAMPLES:
    # Greenfield (new project, default)
    kiro-flow start user-auth "Add OAuth2 authentication with GitHub provider"
    kiro-flow -s start user-auth "Add OAuth2 authentication with GitHub provider"

    # Brownfield (existing codebase)
    kiro-flow -b start payment-flow "Add Stripe payment integration"
    kiro-flow --brownfield start api-v2 "Migrate to new API version"

    # Using a different Claude tier/profile
    kiro-flow -t rocketable start user-auth "Add OAuth2 authentication"
    kiro-flow --tier=rocketable -b start api-v2 "Migrate to new API"

    # Other commands
    kiro-flow resume user-auth
    kiro-flow -t rocketable status user-auth
    kiro-flow status
    kiro-flow list
    kiro-flow abort user-auth

WORKFLOWS:

    GREENFIELD (default) - New projects:
    ┌─────────────────────────────────────────────────────────┐
    │ 1. Initialize     → Create worktree, setup branch       │
    │ 2. Requirements   → Generate EARS requirements [APPROVAL]│
    │ 3. Design         → Generate technical design [APPROVAL] │
    │ 4. Tasks          → Generate implementation tasks [APPROVAL]│
    │ 5. Implementation → Execute tasks with commits          │
    │ 6. Validation     → Validate against requirements       │
    │ 7. PR & Merge     → Create PR, merge on approval [APPROVAL]│
    └─────────────────────────────────────────────────────────┘

    BROWNFIELD (-b) - Existing codebases:
    ┌─────────────────────────────────────────────────────────┐
    │ 1. Initialize      → Create worktree, setup branch      │
    │ 2. Requirements    → Generate EARS requirements [APPROVAL]│
    │ 3. Gap Analysis    → Analyze existing code vs requirements [REVIEW]│
    │ 4. Design          → Generate technical design [APPROVAL]│
    │ 5. Design Validation → Validate design against codebase [REVIEW]│
    │ 6. Tasks           → Generate implementation tasks [APPROVAL]│
    │ 7. Implementation  → Execute tasks with commits         │
    │ 8. Validation      → Validate against requirements      │
    │ 9. PR & Merge      → Create PR, merge on approval [APPROVAL]│
    └─────────────────────────────────────────────────────────┘

    Each phase creates git commits for traceability.
    Use 'resume' to continue if interrupted.

EOF
}

validate_feature_name() {
    local feature="$1"
    if [[ ! "$feature" =~ ^[a-z][a-z0-9-]*$ ]]; then
        echo -e "${RED}Error: Feature name must be lowercase, start with a letter, and contain only letters, numbers, and hyphens.${NC}"
        echo "Example: user-auth, payment-flow, api-v2"
        exit 1
    fi
}

COMMAND="${1:-help}"
shift || true

case "$COMMAND" in
    start)
        FEATURE="$1"
        DESCRIPTION="$2"
        if [ -z "$FEATURE" ] || [ -z "$DESCRIPTION" ]; then
            echo -e "${RED}Error: Missing arguments${NC}"
            echo "Usage: kiro-flow start <feature-name> \"<description>\""
            echo ""
            echo "Example:"
            echo "  kiro-flow start user-auth \"Add OAuth2 authentication with GitHub\""
            exit 1
        fi
        validate_feature_name "$FEATURE"
        print_header
        echo -e "${GREEN}Starting flow for feature: ${FEATURE}${NC}"
        echo -e "Description: ${DESCRIPTION}"
        echo -e "Mode: ${PROJECT_MODE}"
        echo -e "Config: ${CLAUDE_CONFIG_DIR}"
        echo ""
        cd "$PROJECT_ROOT"
        exec claude $SKIP_PERMISSIONS "/kiro-flow:start" "$FEATURE" "$DESCRIPTION" "--mode=$PROJECT_MODE"
        ;;

    resume)
        FEATURE="$1"
        if [ -z "$FEATURE" ]; then
            echo -e "${RED}Error: Missing feature name${NC}"
            echo "Usage: kiro-flow resume <feature-name>"
            exit 1
        fi
        validate_feature_name "$FEATURE"
        print_header
        echo -e "${YELLOW}Resuming flow for feature: ${FEATURE}${NC}"
        echo ""
        cd "$PROJECT_ROOT"
        exec claude $SKIP_PERMISSIONS "/kiro-flow:resume" "$FEATURE"
        ;;

    status)
        FEATURE="$1"
        print_header
        cd "$PROJECT_ROOT"
        if [ -z "$FEATURE" ]; then
            exec claude $SKIP_PERMISSIONS "/kiro-flow:status"
        else
            exec claude $SKIP_PERMISSIONS "/kiro-flow:status" "$FEATURE"
        fi
        ;;

    list)
        print_header
        cd "$PROJECT_ROOT"
        exec claude $SKIP_PERMISSIONS "/kiro-flow:list"
        ;;

    abort)
        FEATURE="$1"
        if [ -z "$FEATURE" ]; then
            echo -e "${RED}Error: Missing feature name${NC}"
            echo "Usage: kiro-flow abort <feature-name>"
            exit 1
        fi
        validate_feature_name "$FEATURE"
        print_header
        echo -e "${RED}Aborting flow for feature: ${FEATURE}${NC}"
        echo ""
        cd "$PROJECT_ROOT"
        exec claude $SKIP_PERMISSIONS "/kiro-flow:abort" "$FEATURE"
        ;;

    help|--help|-h)
        print_help
        ;;

    *)
        echo -e "${RED}Unknown command: ${COMMAND}${NC}"
        echo ""
        print_help
        exit 1
        ;;
esac
